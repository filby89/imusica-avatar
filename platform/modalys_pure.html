<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <title>Modalys Standalone</title>
</head>
<body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="three.js"></script>
    <script src="OrbitControls.js"></script>
    <script type="text/javascript" src="Pizzicato.js"></script>
    <script type="text/javascript" src="kinectAvatar.js"></script>
    <script type="text/javascript" src="world.js"></script>
    <script type="text/javascript" src="Tone.js"></script>
    <script type="text/javascript" src="THREE.MeshLine.js"></script>
    <script type="text/javascript" src="pitchVolumeOrgan.js"></script>
    <script type="text/javascript" src="airGuitar.js"></script>
    <script type="text/javascript" src="airCello.js"></script>
    <script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
    <script src='https://surikov.github.io/webaudiofontdata/sound/0300_LesPaul_sf2.js'></script>
    <script src='https://surikov.github.io/webaudiofontdata/sound/0130_FluidR3_GM_sf2_file.js'></script>
    <script src='https://surikov.github.io/webaudiofontdata/sound/0430_SBLive_sf2.js'></script>
    <script src="lodash.min.js"></script>
    <script src="postal.min.js"></script>
    <script src="modalys.js"></script>
    <script>

        window.onload = function () {
            var buttonStop = document.getElementById("stop-button");
            var label = document.getElementById("status-label");
            var status = document.getElementById("status");
            var running = 1;

            var modalysChannel = postal.channel("modalys");
            var sessionId;

            $("document").ready(function () {
                Modalys.isready.then(function () {

                    //initialize the Modalys engine
                    var audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    Modalys.init(audioContext);
                    Modalys.output.connect(audioContext.destination);
                    console.log("Modalys should be initialized...");
                    //var l = 1.3348;
                    var l = 1;
                    var parts = [];
                    var value = [];
                    //initialize the guitar chords
                    for (var i = 0; i < 6; i++) { //standard tuning: E/A/D/G/B/E
                        value[i] = 0.5;
                        var x = i * 0.01;
                        //var y = Math.pow(0.6666, i); //.... that is not an octave diff, will likely reset to 0.943....
                        parts[i] = {
                            "partId": i + 1,
                            "physicalParameters": {
                                "attachmentPoints": [{
                                    "x": x,
                                    "y": 0.0,
                                    "z": 0.0
                                }, {
                                    "x": x,
                                    "y": l,
                                    "z": 0.0
                                }],
                                "radius": 0.001, //might edit.
                                "tension": 661,
                                "material": "steel"
                            }
                        }
                        //l = l/1.14;
                        l = l/1.3348; //as frequency increases
                        if (i == 3)
                            l = l*1.0595; //in standard tuning the 5th string is tuned 4 tones below the 4th, not 5.

                    }

                    modalysChannel.publish("play", {
                        "requestId": "123456",
                        "instrumentType": "pluckedString",
                        "name": "My polychord",
                        "parts": parts
                    });
                    console.log("Publish request sent.");
                });
            });

            modalysChannel.subscribe("notification", function (data) {
                if (data.hasOwnProperty('status') && data.status == 'ready') {
                    sessionId = data.sessionId;
                    console.log(data.sessionId);
                }
            });
            
            //window.setTimeout(function(){Pluck(2,0,-0.5)},3000);
            window.setTimeout(tune, 5000);
            window.setTimeout(Amajor, 20000);
            window.setTimeout(Emajor, 30000);
            window.setTimeout(Dmajor, 40000);
            window.setTimeout(Cmajor, 50000);
            window.setTimeout(Gmajor, 60000);

            function tune () {
                window.setTimeout(function(){Pluck(1,0,-0.5)},1000);
                window.setTimeout(function(){Pluck(2,0,-0.5)},3000);
                window.setTimeout(function(){Pluck(3,0,-0.5)},5000);
                window.setTimeout(function(){Pluck(4,0,-0.5)},7000);
                window.setTimeout(function(){Pluck(5,0,-0.5)},9000);
                window.setTimeout(function(){Pluck(6,0,-0.5)},11000);
            }
            function Amajor() {
                window.setTimeout(function(){Pluck(2,0,0.5)},1500);
                window.setTimeout(function(){Pluck(3,2,0.5)},1550);
                window.setTimeout(function(){Pluck(4,2,0.5)},1600);
                window.setTimeout(function(){Pluck(5,2,0.5)},1650);
                window.setTimeout(function(){Pluck(6,0,0.5)},1700);
                console.log(sessionId);
            }

            function Emajor() {
                window.setTimeout(function(){Pluck(1,0,0.5)},1500);
                window.setTimeout(function(){Pluck(2,2,-0.5)},1550);
                window.setTimeout(function(){Pluck(3,2,-0.5)},1600);
                window.setTimeout(function(){Pluck(4,1,-0.5)},1650);
                window.setTimeout(function(){Pluck(5,0,-0.5)},1700);
                window.setTimeout(function(){Pluck(6,0,-0.5)},1750);
            }

            function Dmajor(){
                window.setTimeout(function(){Pluck(3,0,0.5)},1500);
                window.setTimeout(function(){Pluck(4,2,0.5)},1550);
                window.setTimeout(function(){Pluck(5,3,0.5)},1600);
                window.setTimeout(function(){Pluck(6,2,0.5)},1650);
            }

            function Cmajor(){
                window.setTimeout(function(){Pluck(2,3,0.5)},1500);
                window.setTimeout(function(){Pluck(3,2,-0.5)},1550);
                window.setTimeout(function(){Pluck(4,0,-0.5)},1600);
                window.setTimeout(function(){Pluck(5,1,-0.5)},1650);
                window.setTimeout(function(){Pluck(6,0,-0.5)},1700);
            }

            function Gmajor(){
                window.setTimeout(function(){Pluck(1,3,-0.5)},1500);
                window.setTimeout(function(){Pluck(2,2,-0.5)},1550);
                window.setTimeout(function(){Pluck(3,0,0.5)},1600);
                window.setTimeout(function(){Pluck(4,0,0.5)},1650);
                window.setTimeout(function(){Pluck(5,3,0.5)},1700);
                window.setTimeout(function(){Pluck(6,3,0.5)},1750);
            }

            function Pluck(string,fret,dir){
                console.log("Plucking");
                var data = {
                    "sessionId": sessionId,
                    "parameters": [
                    {
                        "partId": string,
                        "name": "pitchbend",
                        "value": 100*fret
                    }]
                };
                modalysChannel.publish("updateParameter", data);
                var data = {

                    "sessionId": sessionId,
                    "parameters": [
                    {
                        "partId": string,
                        "name": "position",
                        "value": dir,
                        "when": 0.05
                    }]
                };
                modalysChannel.publish("updateParameter", data);
            }
        }
        </script>

</body>
</html>