<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>iMuSciCA - Athena</title>
        <link rel="icon" href="http://www.imuscica.eu/wp-content/uploads/2017/02/cropped-logo-1-32x32.png" sizes="32x32" />
        <link rel="stylesheet" type="text/css" href="bootstrap4/css/bootstrap.css" />
    </head>
    <body>
    <!-- Just an image -->
<nav class="navbar navbar-light bg-primary text-white">
  <a class="navbar-brand text-white" href="#">
    <img src="logo.png" height="30" alt="">
  </a>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-sm-12 col-md-9">
	  	<h5>3D Kinect Avatar and Gesture Recognition</h5>
		<div id="world" width="960" height="540"></div>
    </div>
    <div class="col-3">
        <div class="row">
            <div class="col">
              <div class="card" style="width: 18rem;">
        	  <div class="card-body">
        	    <h5 class="card-title">Details</h5>
        			<h6> <label id="status">None</label> </h6>

                <div class="form-group">
                  <label for="mode">Select list:</label>
                  <select class="form-control" id="mode">
                	        <option value="1">Air Guitar</option>
                	        <option value="2">Upright Bass</option>
                	        <option value="3">Double Instrument</option>
                      <option value="4"> Two Player Operation</option>
                  </select>
                </div>
                <button type="button" id="start-button"  class="btn btn-primary">Start Mode</button>

                <button type="button" id="stop-button"  class="btn btn-danger">Disconnect</button>
        	  </div>
        	</div>
            </div>

        </div>
    </div>
            <div class="row" id="players">
            </div>
  </div>

</div>
		

		<style>
		#world {
			min-height: 540px;
		}
        #players {
            padding-left: 30px;
        }
		</style>
				

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="three.js"></script>
<script src="OrbitControls.js"></script>
<script type="text/javascript" src="Pizzicato.js"></script>
<script type="text/javascript" src="kinectAvatar.js"></script>
<script type="text/javascript" src="world.js"></script>
<script type="text/javascript" src="player.js"></script>
<script type="text/javascript" src="Tone.js"></script>
<script type="text/javascript" src="THREE.MeshLine.js"></script>
<script type="text/javascript" src="pitchVolumeOrgan.js"></script>
<script type="text/javascript" src="airGuitar.js"></script>
<script type="text/javascript" src="airCello.js"></script>
<script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
<script src='https://surikov.github.io/webaudiofontdata/sound/0300_LesPaul_sf2.js'></script>
<script src='https://surikov.github.io/webaudiofontdata/sound/0130_FluidR3_GM_sf2_file.js'></script>
<script src='https://surikov.github.io/webaudiofontdata/sound/0430_SBLive_sf2.js'></script>
<script src="lodash.min.js"></script>
<script src="postal.min.js"></script>
<script src="modalys.js"></script>
<script>

      
   
window.onload = function () {
  	var buttonStop = document.getElementById("stop-button");	
    var label = document.getElementById("status-label");
	var status = document.getElementById("status");
	var running = 1;

	var modalysChannel = postal.channel("modalys");
	var sessionId;
	$("document").ready(function () {
	    Modalys.isready.then(function () {

	        //initialize the Modalys engine
	        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
	        Modalys.init(audioContext);
	        Modalys.output.connect(audioContext.destination);
	        console.log("Modalys should be initialized...");

	        var parts = [];
            var l = 1;
	        //initialize the guitar chords (6?)
	        for (var i = 0; i < 6; i++){
	            var x = i  * 0.1;
	            parts[i] = {
	                "partId": i + 1,
	                "physicalParameters": {
	                    "attachmentPoints": [{
	                        "x": x,
	                        "y": 0.0,
	                        "z": 0.0
	                    }, {
	                        "x": x,
	                        "y": l,
	                        "z": 0.0
	                    }],
	                    "radius": 0.001, //might edit.
	                    "tension": 94.66
	                }
	            }
                l = l/1.1225; //reducing the length per chord should result in a higher tone...
	        }
	        //var parts = [];
	        modalysChannel.publish("play", {
	            "requestId": "123456",
	            "instrumentType": "pluckedString",
	            "name": "My polychord",
	            "parts": parts
	        });
	        console.log("Publish request sent.");
	    });
	});

    //World and avatar initialization.
    var world = new interactionWorld(document.getElementById("world"));
    world.init();

    var players = [];

	modalysChannel.subscribe("notification", function (data) {
        if (data.hasOwnProperty('status') && data.status == 'ready') {
            sessionId = data.sessionId;
            console.log(data.sessionId);
        }
	});
    


	if (!window.WebSocket) {
        status.innerHTML = "Your browser does not support web sockets!";
        status.classList.add("text-danger");
        return;
    }

    status.innerHTML = "Connecting to server...";
    var socket = new WebSocket("ws://localhost:8181");

    /* modes:
	0: idle
	1: air guitar
	2: cello
    3: double instrument
	4: two players
    */

    var mode = 0;
  	var buttonSwitchMode = $("#start-button");	

  	buttonSwitchMode.click(function () { //does this only activate on start/stop clicking? // yeap! -
    	if (mode > 0) {
    		buttonSwitchMode.addClass("btn-primary");
    		buttonSwitchMode.removeClass("btn-warning");
    		buttonSwitchMode.html("Start");
    		mode = 0;
    	}
    	else {
    		buttonSwitchMode.addClass("btn-warning");
    		buttonSwitchMode.removeClass("btn-primary");
    		buttonSwitchMode.html("Stop");
    		mode = parseInt($("#mode").val());
    	}
    });

    socket.onmessage = function (event) {				
        if (typeof event.data === "string") {
			// Create a JSON object.
            var jsonObject = JSON.parse(event.data);

            //Case 1: A dynamic gesture event (currently only a start event) is received.
			if (jsonObject.gesture) {
				if (jsonObject.gesture == "start") {
					running = 1;
					console.log("Starting");
				}
			}

            //Case 2: A bunch of skeletal data has been received.
			if (jsonObject.skeletons) {
			    for (var i = 0; i < jsonObject.skeletons.length; i++)
			    {
                    var data = jsonObject.skeletons[i]; 
					var rightHandY = data.joints[11].y;
					var headY = data.joints[3].y;
					if (rightHandY > headY + 0.2)
					{
					    //running = 0;
					    console.log("Stopping");
					}
				}
			}

            if (jsonObject.skeletons) {
                // refresh html elements [regardless of start/stop, this only refreshes the screen]
                for (var i = 0; i < jsonObject.skeletons.length; i++) {
                    var ID = jsonObject.skeletons[i].id;
                    // console.log(ID);
                    var found = false;
                    for (var j = 0; j < players.length; j++) {
                        if (players[j].ID == ID) {
                            if (mode != 4) {
                                players[j].refresh(jsonObject.skeletons[i], mode);
                            }
                            else {
                                var _mode = 1+j%2;
                                players[j].refresh(jsonObject.skeletons[i], _mode);
                            }
                            found = true;
                            // console.log("Refreshin");
                        }
                    }
                    // console.log(players.length);
                    if (!found) {
                        var player = new Player(world, ID, modalysChannel, sessionId, $("#players"));
                        // player.refresh(jsonObject.skeletons[i], mode);
                        players.push(player);
                    }
                }

                // do the reverse - search if a player was lost so that we remove him -- todo a better implementation 
                // quick fix for now
                for (var j = 0; j < players.length; j++) {
                    var ID = players[j].id;

                    var found = false;

                    for (var i = 0; i < jsonObject.skeletons.length; i++) {
                        if (jsonObject.skeletons[i].ID == ID) {
                            found = true;
                        }
                    }

                    if (!found) {
                        players[j].removeFromScene();
                        players.splice(j,1);
                    }
                }                
            }

        }
    }

    // remove avatars that have not been refreshed in the last 200 ms
    setInterval(function() {
        for (var i=0; i<players.length; i++) {
            // console.log(players[i].last_refresh-Date.now());
           if (Date.now() - players[i].last_refresh > 500) {
                players[i].removeFromScene();
                players.splice(i,1);
            } 
        }
    }, 30);


    socket.onclose = function (event) {
        var code = event.code;
        var reason = event.reason;
        var wasClean = event.wasClean;		
		
        if (wasClean) {
            status.innerHTML = "Connection closed normally.";
        }
        else {
            status.innerHTML = "Connection closed with message: " + reason + " (Code: " + code + ")";
        }
    }

    socket.onerror = function (event) {
        status.innerHTML = "Error: " + event;
    }

    buttonStop.onclick = function (event) {
        if (socket.readyState == WebSocket.OPEN) {
            socket.close();
        }
    }

    socket.onopen = function () {
        status.innerHTML = "Connection successful.";
        status.classList.add("text-success");
		console.log("Connection successful.");
    };
}
	
		</script>

    </body>
</html>



